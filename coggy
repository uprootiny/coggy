#!/usr/bin/env bash
# COGGY launcher
# - `coggy` defaults to interactive REPL
# - `coggy ctl <subcommand>` forwards to scripts/deploy/coggyctl.sh
# - common subcommands map directly to babashka entrypoints

set -euo pipefail

ROOT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
CTL="${ROOT_DIR}/scripts/deploy/coggyctl.sh"

if [[ ! -f "${ROOT_DIR}/bb.edn" ]]; then
  echo "coggy: bb.edn not found in ${ROOT_DIR}" >&2
  exit 1
fi

cmd="${1:-repl}"
shift || true

case "${cmd}" in
  repl)
    exec bb "${ROOT_DIR}/src/coggy/main.clj" "$@"
    ;;
  serve|boot|doctor)
    exec bb "${ROOT_DIR}/src/coggy/main.clj" "${cmd}" "$@"
    ;;
  test)
    exec bb "${ROOT_DIR}/test/coggy/atomspace_test.clj" "$@"
    ;;
  cockpit|up|start|stop|restart|status|fleet|chat|smoke|logs|bench)
    exec "${CTL}" "${cmd}" "$@"
    ;;
  ctl)
    exec "${CTL}" "$@"
    ;;
  help|-h|--help)
    cat <<'EOF'
Usage: coggy [repl|serve|boot|doctor|test|up|start|stop|restart|status|fleet|chat|smoke|logs|cockpit|bench|ctl]

Examples:
  coggy
  coggy serve 8421
  coggy status
  coggy ctl doctor
EOF
    ;;
  *)
    echo "coggy: unknown command '${cmd}' (run 'coggy help')" >&2
    exit 2
    ;;
esac
