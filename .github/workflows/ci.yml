name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq shellcheck
          curl -sLO https://raw.githubusercontent.com/babashka/babashka/master/install
          chmod +x install
          sudo ./install

      - name: Verify bb
        run: bb --version

      - name: Shellcheck scripts
        run: |
          shellcheck coggy scripts/coggy-client scripts/deploy/coggyctl.sh scripts/tmux/*.sh

      - name: Run tests
        run: |
          bb test/coggy/atomspace_test.clj
          bb test/coggy/domain_test.clj
          bb test/coggy/bench_test.clj

      - name: Smoke test boot
        run: |
          bb -e '
          (require (quote [coggy.atomspace :as as])
                   (quote [coggy.attention :as att])
                   (quote [coggy.boot :as boot]))
          (let [space (as/make-space)
                bank (att/make-bank)]
            (boot/seed-ontology! space bank)
            (let [stats (as/space-stats space)]
              (assert (>= (:atoms stats) 10) "boot should seed atoms")
              (assert (>= (:links stats) 4) "boot should seed links")
              (println (str "Boot OK: " (:atoms stats) " atoms, " (:links stats) " links"))))'

      - name: Smoke test web server startup
        run: |
          bb -e '
          (require (quote [coggy.atomspace :as as])
                   (quote [coggy.attention :as att])
                   (quote [coggy.boot :as boot])
                   (quote [coggy.repl :as repl])
                   (quote [coggy.web :as web])
                   (quote [org.httpkit.server :as srv])
                   (quote [babashka.http-client :as http]))
          (let [space (as/make-space)
                bank (att/make-bank)]
            (boot/seed-ontology! space bank)
            (reset! repl/session
                    {:space space :bank bank :history []
                     :turn 0 :concepts-seen #{}
                     :active-domain nil
                     :started-at (System/currentTimeMillis)})
            (let [stop-fn (srv/run-server web/handler {:port 18421})]
              (Thread/sleep 500)
              (let [resp (http/get "http://localhost:18421/health" {:throw false})]
                (assert (= 200 (:status resp)) "health should return 200"))
              (let [resp (http/get "http://localhost:18421/api/state" {:throw false})]
                (assert (= 200 (:status resp)) "state should return 200"))
              (let [resp (http/get "http://localhost:18421/" {:throw false})]
                (assert (= 200 (:status resp)) "index should return 200"))
              (let [resp (http/get "http://localhost:18421/api/metrics" {:throw false})]
                (assert (= 200 (:status resp)) "metrics should return 200"))
              (let [resp (http/get "http://localhost:18421/api/events" {:throw false})]
                (assert (= 200 (:status resp)) "events should return 200"))
              (let [resp (http/get "http://localhost:18421/api/focus" {:throw false})]
                (assert (= 200 (:status resp)) "focus should return 200"))
              (let [resp (http/post "http://localhost:18421/api/observe"
                           {:headers {"Content-Type" "application/json"}
                            :body "{\"concepts\":[\"test-agent\",\"smoke\"],\"relations\":[],\"confidence\":0.5,\"source\":\"ci\"}"
                            :throw false})]
                (assert (= 200 (:status resp)) "observe should return 200"))
              (let [resp (http/post "http://localhost:18421/api/query"
                           {:headers {"Content-Type" "application/json"}
                            :body "{\"concepts\":[\"test-agent\"]}"
                            :throw false})]
                (assert (= 200 (:status resp)) "query should return 200"))
              (let [resp (http/get "http://localhost:18421/api/atoms/test-agent" {:throw false})]
                (assert (= 200 (:status resp)) "atom lookup should return 200"))
              (stop-fn)
              (println "Web server smoke test OK")))'

      - name: Smoke test semantic pipeline
        run: |
          bb -e '
          (require (quote [coggy.atomspace :as as])
                   (quote [coggy.attention :as att])
                   (quote [coggy.semantic :as sem]))
          (let [space (as/make-space)
                bank (att/make-bank)
                text "response\n```semantic\n{:concepts [\"alpha\" \"beta\"] :relations [{:type :inherits :a \"alpha\" :b \"beta\"}] :confidence 0.8}\n```"]
            (let [result (sem/process-semantic! space bank text)]
              (assert (some? (:semantic result)) "should extract semantic")
              (assert (= 2 (count (get-in result [:semantic :concepts]))) "should have 2 concepts")
              (assert (some? (as/get-atom space "alpha")) "alpha should be grounded")
              (println (str "Semantic pipeline OK: " (get-in result [:metrics :turns]) " turns tracked"))))'

  smoke-and-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Babashka
        run: |
          curl -sLO https://raw.githubusercontent.com/babashka/babashka/master/install
          chmod +x install
          sudo ./install

      - name: Run coggy smoke
        run: |
          COGGY_PORT=18421 HYLE_PORT=18422 ./scripts/deploy/coggyctl.sh smoke | tee ci-smoke.log

      - name: Capture API state sample
        run: |
          COGGY_PORT=18421 HYLE_PORT=18422 ./scripts/deploy/coggyctl.sh start
          sleep 2
          curl -fsS http://127.0.0.1:18421/health | tee ci-health.json
          curl -fsS http://127.0.0.1:18421/api/state | head -c 50000 > ci-state.json
          COGGY_PORT=18421 HYLE_PORT=18422 ./scripts/deploy/coggyctl.sh stop

      - name: Upload CI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coggy-ci-artifacts
          path: |
            ci-smoke.log
            ci-health.json
            ci-state.json
